name: ğŸš€ DÃ©ploiement manuel

on:
  workflow_dispatch:
    inputs:
      type:
        description: "Type de rÃ©fÃ©rence"
        required: true
        default: "tag"
        type: choice
        options:
          - tag
          - branche
          - commit
      reference:
        description: "RÃ©fÃ©rence Ã  dÃ©ployer"
        required: true

jobs:
# devenu obsolÃ¨te Ã  la disparition du front dans ce workflow et required true de la rÃ©fÃ©rence, mais je laisse pour moment
  inputs_validation:
    name: Validation des inputs
    runs-on: ubuntu-latest
    steps:
      - name: Validation
        run: |
          echo "VÃ©rification qu'au moins un tag / commit / branche est renseignÃ©"
          echo "${{ inputs.reference }}" | grep -P '^.+$'

  deploy:
    name: DÃ©ploiement
    runs-on: ubuntu-latest
    needs: inputs_validation

    env:
      SSH_USER: ${{ secrets.SSH_USER }}
      SSH_HOST: ${{ secrets.SSH_HOST }}
      SSH_PORT: ${{ secrets.SSH_PORT }}
      DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}

    steps:
      - name: Chargement des secrets
        run: |
          echo "SSH_USER=$SSH_USER" >> $GITHUB_ENV
          echo "SSH_HOST=$SSH_HOST" >> $GITHUB_ENV
          echo "SSH_PORT=$SSH_PORT" >> $GITHUB_ENV
          echo "DEPLOY_PATH=$DEPLOY_PATH" >> $GITHUB_ENV

      - name: Configuration clÃ© SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets['SSH_PK'] }}" >> ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p $SSH_PORT -H $SSH_HOST >> ~/.ssh/known_hosts

      - name: DÃ©ploiement backend
        id: deployment-back
        run: |
          ssh $SSH_USER@$SSH_HOST -p $SSH_PORT "
            set -e
            echo 'ğŸ“¦ CrÃ©ation backup' && \
            rm -rf $DEPLOY_PATH/app.bak && \
            mv $DEPLOY_PATH/app $DEPLOY_PATH/app.bak && \
            mkdir $DEPLOY_PATH/app && \
            echo 'ğŸ“¦ CrÃ©ation OK' && \
            echo 'â™»ï¸ Mise Ã  jour repository' && \
            cd $DEPLOY_PATH/code && \
            git fetch && \
            git clean -f && \
            git checkout ${{ inputs.reference }} && \
            git pull && \
            echo 'â™»ï¸ Mise Ã  jour OK' && \
            echo 'ğŸ› ï¸ Build release' && \
            /home/$SSH_USER/.cargo/bin/cargo build --release && \
            echo 'ğŸ› ï¸ Build OK' && \
            echo 'ğŸ“² Mise Ã  jour backend' && \
            cp -r ./target/release/* $DEPLOY_PATH/app/ && \
            cp $DEPLOY_PATH/app.bak/.env $DEPLOY_PATH/app/ && \
            echo 'ğŸ“² Mise Ã  jour OK' && \
            echo 'ğŸš€ Restart backend' && \
            ${{ secrets['RESTART_CMD'] }}
            echo 'ğŸš€ Restart OK'
          "

      - name: Nettoyage des backups
        if: steps.deployment-back.outcome == 'success'
        run: |
          echo "ğŸ›°ï¸ Envoi des backups en orbite..."
          ssh $SSH_USER@$SSH_HOST -p $SSH_PORT "
            rm -rf $DEPLOY_PATH/app.bak
          "
          echo "ğŸ›°ï¸ Envoi OK"
